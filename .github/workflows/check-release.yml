name: Check GitHub Release

on:
  schedule:
    # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡ (UTC æ—¶é—´)
    - cron: '0 * * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # ========== åœ¨è¿™é‡Œæ·»åŠ è¦ç›‘æŽ§çš„ä»“åº“ ==========
          - repo: router-for-me/CLIProxyAPIPlus
            name: CLIProxyAPIPlus
          - repo: 2dust/v2rayN
            name: v2rayN
          # ==========================================
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check latest release
        id: check
        run: |
          REPO="${{ matrix.repo }}"
          SAFE_NAME=$(echo "$REPO" | tr '/' '_')
          
          # èŽ·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
          RELEASE_JSON=$(curl -s "https://api.github.com/repos/${REPO}/releases/latest")
          LATEST=$(echo "$RELEASE_JSON" | jq -r '.tag_name')
          RELEASE_BODY=$(echo "$RELEASE_JSON" | jq -r '.body // "æ— æ›´æ–°è¯´æ˜Ž"' | head -c 1500)
          
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          echo "safe_name=$SAFE_NAME" >> $GITHUB_OUTPUT
          
          # ä¿å­˜æ›´æ–°å†…å®¹åˆ°æ–‡ä»¶ï¼ˆé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜ï¼‰
          echo "$RELEASE_BODY" > /tmp/release_body.txt
          
          # è¯»å–æœ¬åœ°è®°å½•çš„ç‰ˆæœ¬
          VERSION_FILE="versions/${SAFE_NAME}.txt"
          if [ -f "$VERSION_FILE" ]; then
            CURRENT=$(cat "$VERSION_FILE")
          else
            CURRENT=""
          fi
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          
          if [ "$LATEST" != "$CURRENT" ] && [ -n "$LATEST" ] && [ "$LATEST" != "null" ]; then
            echo "has_update=true" >> $GITHUB_OUTPUT
          else
            echo "has_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Feishu notification
        if: steps.check.outputs.has_update == 'true'
        run: |
          # è¯»å–æ›´æ–°å†…å®¹å¹¶è½¬ä¹‰
          BODY=$(cat /tmp/release_body.txt | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g' | head -c 1000)
          
          curl -X POST "${{ secrets.FEISHU_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"msg_type\": \"interactive\",
              \"card\": {
                \"header\": {
                  \"title\": {\"tag\": \"plain_text\", \"content\": \"ðŸš€ ${{ matrix.name }} æ–°ç‰ˆæœ¬å‘å¸ƒ\"},
                  \"template\": \"blue\"
                },
                \"elements\": [
                  {
                    \"tag\": \"div\",
                    \"text\": {\"tag\": \"lark_md\", \"content\": \"**æœ€æ–°ç‰ˆæœ¬**: ${{ steps.check.outputs.latest }}\"}
                  },
                  {
                    \"tag\": \"div\",
                    \"text\": {\"tag\": \"lark_md\", \"content\": \"**æ›´æ–°å†…å®¹**:\\n${BODY}\"}
                  },
                  {
                    \"tag\": \"action\",
                    \"actions\": [
                      {
                        \"tag\": \"button\",
                        \"text\": {\"tag\": \"plain_text\", \"content\": \"æŸ¥çœ‹å‘å¸ƒé¡µé¢\"},
                        \"url\": \"https://github.com/${{ matrix.repo }}/releases\",
                        \"type\": \"primary\"
                      }
                    ]
                  }
                ]
              }
            }"

      - name: Update version file
        if: steps.check.outputs.has_update == 'true'
        run: |
          mkdir -p versions
          echo "${{ steps.check.outputs.latest }}" > "versions/${{ steps.check.outputs.safe_name }}.txt"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add versions/
          git commit -m "Update ${{ matrix.name }} to ${{ steps.check.outputs.latest }}"
          git push
