name: Check GitHub Release

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # ========== åœ¨è¿™é‡Œæ·»åŠ è¦ç›‘æŽ§çš„ä»“åº“ ==========
          - repo: router-for-me/CLIProxyAPIPlus
            name: CLIProxyAPIPlus
          - repo: 2dust/v2rayN
            name: v2rayN
          # ==========================================
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check latest release
        id: check
        run: |
          REPO="${{ matrix.repo }}"
          SAFE_NAME=$(echo "$REPO" | tr '/' '_')
          
          # èŽ·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯ï¼ˆä¸é™åˆ¶å­—æ•°ï¼‰
          RELEASE_JSON=$(curl -s "https://api.github.com/repos/${REPO}/releases/latest")
          LATEST=$(echo "$RELEASE_JSON" | jq -r '.tag_name')
          RELEASE_BODY=$(echo "$RELEASE_JSON" | jq -r '.body // "æ— æ›´æ–°è¯´æ˜Ž"')
          
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          echo "safe_name=$SAFE_NAME" >> $GITHUB_OUTPUT
          
          # ä¿å­˜æ›´æ–°å†…å®¹åˆ°æ–‡ä»¶
          echo "$RELEASE_BODY" > /tmp/release_body.txt
          
          # è¯»å–æœ¬åœ°è®°å½•çš„ç‰ˆæœ¬
          VERSION_FILE="versions/${SAFE_NAME}.txt"
          if [ -f "$VERSION_FILE" ]; then
            CURRENT=$(cat "$VERSION_FILE")
          else
            CURRENT=""
          fi
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          
          if [ "$LATEST" != "$CURRENT" ] && [ -n "$LATEST" ] && [ "$LATEST" != "null" ]; then
            echo "has_update=true" >> $GITHUB_OUTPUT
          else
            echo "has_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Translate if English
        if: steps.check.outputs.has_update == 'true'
        run: |
          BODY=$(cat /tmp/release_body.txt)
          
          # æ£€æµ‹æ˜¯å¦ä¸»è¦æ˜¯è‹±æ–‡
          TOTAL_CHARS=$(echo "$BODY" | wc -c)
          ASCII_CHARS=$(echo "$BODY" | tr -cd '\000-\177' | wc -c)
          
          if [ "$TOTAL_CHARS" -gt 0 ]; then
            RATIO=$((ASCII_CHARS * 100 / TOTAL_CHARS))
          else
            RATIO=0
          fi
          
          if [ "$RATIO" -gt 70 ]; then
            # è‹±æ–‡å†…å®¹ï¼Œè°ƒç”¨ç¿»è¯‘API
            ENCODED_BODY=$(echo "$BODY" | jq -sRr @uri)
            TRANSLATED=$(curl -s "https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=zh-CN&dt=t&q=${ENCODED_BODY}" | jq -r '.[0][][0]')
            if [ -n "$TRANSLATED" ] && [ "$TRANSLATED" != "null" ]; then
              echo "$TRANSLATED" > /tmp/release_body_final.txt
            else
              echo "$BODY" > /tmp/release_body_final.txt
            fi
          else
            echo "$BODY" > /tmp/release_body_final.txt
          fi

      - name: Send Feishu notification
        if: steps.check.outputs.has_update == 'true'
        run: |
          BODY=$(cat /tmp/release_body_final.txt)
          
          # æž„å»ºæ¶ˆæ¯æ–‡æœ¬
          TEXT="ðŸš€ ${{ matrix.name }} æ–°ç‰ˆæœ¬å‘å¸ƒ
æœ€æ–°ç‰ˆæœ¬: ${{ steps.check.outputs.latest }}
æ›´æ–°å†…å®¹:
${BODY}
æŸ¥çœ‹: https://github.com/${{ matrix.repo }}/releases"
          
          # è½¬ä¹‰JSON
          TEXT_ESCAPED=$(echo "$TEXT" | python3 -c "import sys,json; print(json.dumps(sys.stdin.read()))")
          
          curl -X POST "${{ secrets.FEISHU_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "{\"msg_type\": \"text\", \"content\": {\"text\": ${TEXT_ESCAPED}}}"

      - name: Update version file
        if: steps.check.outputs.has_update == 'true'
        run: |
          mkdir -p versions
          echo "${{ steps.check.outputs.latest }}" > "versions/${{ steps.check.outputs.safe_name }}.txt"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add versions/
          git commit -m "Update ${{ matrix.name }} to ${{ steps.check.outputs.latest }}"
          git push
