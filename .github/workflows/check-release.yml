name: Check GitHub Release

on:
  schedule:
    # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡ (UTC æ—¶é—´)
    - cron: '0 * * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Check latest release
        id: check
        run: |
          # èŽ·å–æœ€æ–°ç‰ˆæœ¬
          LATEST=$(curl -s https://api.github.com/repos/router-for-me/CLIProxyAPIPlus/releases/latest | jq -r '.tag_name')
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          
          # è¯»å–ä¸Šæ¬¡è®°å½•çš„ç‰ˆæœ¬
          CURRENT=$(curl -s "https://api.github.com/repos/${{ github.repository }}/contents/version.txt" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" | jq -r '.content' | base64 -d 2>/dev/null || echo "")
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          
          if [ "$LATEST" != "$CURRENT" ] && [ -n "$LATEST" ]; then
            echo "has_update=true" >> $GITHUB_OUTPUT
          else
            echo "has_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Feishu notification
        if: steps.check.outputs.has_update == 'true'
        run: |
          curl -X POST "${{ secrets.FEISHU_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "interactive",
              "card": {
                "header": {
                  "title": {"tag": "plain_text", "content": "ðŸš€ CLIProxyAPIPlus æ–°ç‰ˆæœ¬å‘å¸ƒ"},
                  "template": "blue"
                },
                "elements": [
                  {
                    "tag": "div",
                    "text": {"tag": "lark_md", "content": "**æœ€æ–°ç‰ˆæœ¬**: ${{ steps.check.outputs.latest }}"}
                  },
                  {
                    "tag": "action",
                    "actions": [
                      {
                        "tag": "button",
                        "text": {"tag": "plain_text", "content": "æŸ¥çœ‹å‘å¸ƒé¡µé¢"},
                        "url": "https://github.com/router-for-me/CLIProxyAPIPlus/releases",
                        "type": "primary"
                      }
                    ]
                  }
                ]
              }
            }'

      - name: Update version file
        if: steps.check.outputs.has_update == 'true'
        run: |
          echo "${{ steps.check.outputs.latest }}" > version.txt
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add version.txt
          git commit -m "Update version to ${{ steps.check.outputs.latest }}" || true
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
