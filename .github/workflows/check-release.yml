name: Check GitHub Release

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - repo: router-for-me/CLIProxyAPIPlus
            name: CLIProxyAPIPlus
          - repo: 2dust/v2rayN
            name: v2rayN
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check latest release
        id: check
        run: |
          REPO="${{ matrix.repo }}"
          SAFE_NAME=$(echo "$REPO" | tr '/' '_')
          
          RELEASE_JSON=$(curl -s "https://api.github.com/repos/${REPO}/releases/latest")
          LATEST=$(echo "$RELEASE_JSON" | jq -r '.tag_name')
          RELEASE_BODY=$(echo "$RELEASE_JSON" | jq -r '.body // "æ— æ›´æ–°è¯´æ˜Ž"')
          
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          echo "safe_name=$SAFE_NAME" >> $GITHUB_OUTPUT
          echo "$RELEASE_BODY" > /tmp/release_body.txt
          
          VERSION_FILE="versions/${SAFE_NAME}.txt"
          if [ -f "$VERSION_FILE" ]; then
            CURRENT=$(cat "$VERSION_FILE")
          else
            CURRENT=""
          fi
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          
          if [ "$LATEST" != "$CURRENT" ] && [ -n "$LATEST" ] && [ "$LATEST" != "null" ]; then
            echo "has_update=true" >> $GITHUB_OUTPUT
          else
            echo "has_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Translate if English
        if: steps.check.outputs.has_update == 'true'
        run: |
          BODY=$(cat /tmp/release_body.txt)
          TOTAL_CHARS=$(echo "$BODY" | wc -c)
          ASCII_CHARS=$(echo "$BODY" | tr -cd '\000-\177' | wc -c)
          
          if [ "$TOTAL_CHARS" -gt 0 ]; then
            RATIO=$((ASCII_CHARS * 100 / TOTAL_CHARS))
          else
            RATIO=0
          fi
          
          if [ "$RATIO" -gt 70 ]; then
            ENCODED_BODY=$(echo "$BODY" | jq -sRr @uri)
            TRANSLATED=$(curl -s "https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=zh-CN&dt=t&q=${ENCODED_BODY}" | jq -r '.[0][][0]')
            if [ -n "$TRANSLATED" ] && [ "$TRANSLATED" != "null" ]; then
              echo "$TRANSLATED" > /tmp/release_body_final.txt
            else
              echo "$BODY" > /tmp/release_body_final.txt
            fi
          else
            echo "$BODY" > /tmp/release_body_final.txt
          fi

      - name: Send Feishu notification
        if: steps.check.outputs.has_update == 'true'
        run: |
          BODY=$(cat /tmp/release_body_final.txt)
          REPO="${{ matrix.repo }}"
          NAME="${{ matrix.name }}"
          VERSION="${{ steps.check.outputs.latest }}"
          
          python3 << 'EOF'
          import json
          import os
          import urllib.request
          
          body = open('/tmp/release_body_final.txt').read()
          name = os.environ.get('NAME', '')
          version = os.environ.get('VERSION', '')
          repo = os.environ.get('REPO', '')
          webhook = os.environ.get('WEBHOOK', '')
          
          text = f"""ðŸš€ {name} æ–°ç‰ˆæœ¬å‘å¸ƒ
          æœ€æ–°ç‰ˆæœ¬: {version}
          æ›´æ–°å†…å®¹:
          {body}
          æŸ¥çœ‹: https://github.com/{repo}/releases"""
          
          payload = json.dumps({"msg_type": "text", "content": {"text": text}}).encode('utf-8')
          req = urllib.request.Request(webhook, data=payload, headers={'Content-Type': 'application/json'})
          urllib.request.urlopen(req)
          EOF
        env:
          NAME: ${{ matrix.name }}
          VERSION: ${{ steps.check.outputs.latest }}
          REPO: ${{ matrix.repo }}
          WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}

      - name: Update version file
        if: steps.check.outputs.has_update == 'true'
        run: |
          mkdir -p versions
          echo "${{ steps.check.outputs.latest }}" > "versions/${{ steps.check.outputs.safe_name }}.txt"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add versions/
          git commit -m "Update ${{ matrix.name }} to ${{ steps.check.outputs.latest }}"
          git push
